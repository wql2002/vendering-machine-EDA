# vendering-machine-EDA
 A self-designed automatic vendering machine based on the EDA, FPGA



## 设计思路和各模块的实现方法。

### 顶层原理图![image-20230302133053953](C:\Users\wql2002\AppData\Roaming\Typora\typora-user-images\image-20230302133053953.png)

### 有限状态机的状态图

![image-20230302133111793](C:\Users\wql2002\AppData\Roaming\Typora\typora-user-images\image-20230302133111793.png)

### 设计思路

​    首先分析自动售货机的功能，大致有投币按钮、购买开关、内部计数器、提示灯、数码管显示金额、数据置零等，同时使用有限状态机来处理核心功能。整个工程大致分为按键消抖模块、核心售货机模块和数码管译码显示模块。

按键消抖模块用一个临时变量储存当前状态的前一状态，当经过一定时间该临时变量与当前输入均相同则将最终输出改为当前输入，表示输入已经稳定；否则输入仍未稳定，重新进行计数。

数码管译码显示模块与EDA1类似，通过循环扫描，并将当前数据译码成数码管形式即可。

核心售货机模块调用前两个模块，并结合有限状态机实现。注意到投币功能并不属于任何一个状态，用边沿检测判断进行计数即可，并将投币输入进行消抖处理。有限状态机分为状态转移模块、时序输出模块和状态更新模块，定义了IDLE（默认初始状态）、SHOP_1（购买商品1状态）、SHOP_2（购买商品2状态）、CHECK（购买成功提示状态）、ERROR（少钱提示模块）、REFUND（退款模块）。

- 状态转移模块中，状态默认处于IDLE，当接收到购买1、2商品的输入信号后，若钱够，则将下一状态设为SHOP_1、SHOP_2，否则将下一状态设为ERROR;当接收到退款信号后，下一状态设为REFUND。处于SHOP_1、SHOP_2状态时，下一状态为CHECK。在处于CHECK、ERROR和REFUND状态时，启用专用计时器，当经过3秒后下一状态变为IDLE，否则仍处于原来状态。
- 时序输出模块中，处于IDLE时将3个提示灯熄灭。处于SHOP_1、SHOP_2状态时将购买1、2商品计数变量+1。处于CHECK、ERROR、REFUND状态时将3个提示灯输出设为1，让灯亮。
- 状态更新模块中，当置零开关为零时，当前状态为IDLE，否则当前状态更新为下一状态。

 

## 具体代码及仿真波形。

### 代码

### 消抖模块

 `debounce.v`

### 数码管显示模块

`select_seg.v`

### 核心售货机模块

`sell_machine_2.v`



## 实验中遇到的主要问题和解决方法。

（1）有限状态机设计混乱，难以debug。处理方法：重写，严格将状态机分为状态转移、状态更新和时序输出三个模块。

（2）将投币信号放入状态转移模块中，且直接用一个“money”变量在处理所有投币、购买操作，导致money变化混乱，难以处理。处理方法：将投币信号移出状态机，直接使用边沿判断（一开始将3个投币信号放入同一个always模块中，导致有两个变化混乱，后将其分为3个always模块后解决），并用多个变量分别对投币数、购买数进行计数（此时新增了一个过渡状态，以保证一次变化只进行一次计数），最后将money用关于投币数、购买数的多项式进行表达、输出。
